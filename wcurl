#!/bin/bash

# wcurl - a simple wrapper around curl for easily downloading files.
# version: 2024-05-14
#
# Copyright (C) Samuel Henrique, <samueloph@debian.org>.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice (including the next
# paragraph) shall be included in all copies or substantial portions of the
# Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# SPDX-License-Identifier: MIT

function print_help {
    printf "Usage: wcurl [-o|--opts=<CURL_OPTIONS>...] <URL>...\n"
    printf "For all options use the manual: man wcurl\n"
}

# Initialize array which stores list of encoded URLs.
declare -a urls_to_download=()

# If no arguments were provided, show the help output and exit with an error.
if [ $# -eq 0 ]; then
    >&2 echo "No arguments provided, here's the help output:"
    print_help
    exit 1
fi

# Parse arguments and encode URLs to be downloaded.
for argument in "$@"
do
    # Check if argument is a parameter, we need to pass those to curl.
    if [[ $argument == -o=* ]] || [[ $argument == --opts=* ]]; then
        curl_opts="${argument#*=}"
    # Show help output on -h|--help
    elif [[ $argument == "-h" ]] || [[ $argument == "--help" ]]; then
        print_help
        exit 0
    # Unknown parameter provided.
    elif [[ $argument == -* ]]; then
        echo "Unsuported parameter provided, only -o= and --opts= are supported: $argument"
        exit 1
    # If it's not a parameter, assume it's an URL.
    else
        # Encode whitespaces into %20, since wget supports those URLs.
        urls_to_download+=("${argument/ /%20/}")
    fi
done

# Download URLs one by one.
# It's not possible to download them in parallel due to the way "--continue-at-"
# works.
# Paralelism can be achieved by the way the user invokes wcurl.
for url in "${urls_to_download[@]}"; do
    # shellcheck disable=SC2086
    curl --location --remote-name --retry 10 --retry-max-time 10 $curl_opts \
    --continue-at - "$url"
done
